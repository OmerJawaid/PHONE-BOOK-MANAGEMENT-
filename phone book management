#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_NAME_LENGTH 35
#define MAX_ADDRESS_LENGTH 50
#define MAX_PHONE_LENGTH 15
#define MAX_SEX_LENGTH 8
#define MAX_EMAIL_LENGTH 100
#define MAX_CITIZENSHIP_LENGTH 20

struct Person {
    char *name;
    char *address;
    char *father_name;
    char *mother_name;
    char *mble_no;
    char *sex;
    char *mail;
    char *citision_no;
};

class Phonebook {
private:
    FILE *file;

public:
    Phonebook(const char *filename) {
        file = fopen(filename, "ab+");
        if (file == NULL) {
            printf("Error opening file.\n");
            exit(1);
        }
    }

    ~Phonebook() {
        fclose(file);
    }

    void addRecord();
    void listRecord();
    void modifyRecord();
    void searchRecord();
    void deleteRecord();

private:
    void writePersonToFile(struct Person *p);
    void readPersonFromFile(struct Person *p);
    void freePersonMemory(struct Person *p);
    char *getStringInput(const char *prompt);
};

void Phonebook::addRecord() {
    struct Person p;
    p.name = getStringInput("Enter name: ");
    p.address = getStringInput("Enter the address: ");
    p.father_name = getStringInput("Enter father's name: ");
    p.mother_name = getStringInput("Enter mother's name: ");
    p.mble_no = getStringInput("Enter phone no.: ");
    p.sex = getStringInput("Enter sex: ");
    p.mail = getStringInput("Enter e-mail: ");
    p.citision_no = getStringInput("Enter citizen no.: ");

    writePersonToFile(&p);
    freePersonMemory(&p);
}

void Phonebook::listRecord() {
    struct Person p;
    while (fread(&p, sizeof(p), 1, file) == 1) {
        printf("\nName: %s\nAddress: %s\nFather name: %s\nMother name: %s\nMobile no: %s\nSex: %s\nE-mail: %s\nCitizen no: %s\n",
               p.name, p.address, p.father_name, p.mother_name, p.mble_no, p.sex, p.mail, p.citision_no);
    }
}

void Phonebook::modifyRecord() {
    struct Person p;
    char name[MAX_NAME_LENGTH];
    printf("\nEnter the name of the person to modify: ");
    fgets(name, MAX_NAME_LENGTH, stdin);
    name[strcspn(name, "\n")] = 0; // Remove newline character

    bool found = false;
    long int pos = ftell(file);

    while (fread(&p, sizeof(p), 1, file) == 1) {
        if (strcmp(p.name, name) == 0) {
            found = true;
            printf("\nEnter new data:\n");
            p.name = getStringInput("Enter name: ");
            p.address = getStringInput("Enter the address: ");
            p.father_name = getStringInput("Enter father's name: ");
            p.mother_name = getStringInput("Enter mother's name: ");
            p.mble_no = getStringInput("Enter phone no.: ");
            p.sex = getStringInput("Enter sex: ");
            p.mail = getStringInput("Enter e-mail: ");
            p.citision_no = getStringInput("Enter citizen no.: ");

            fseek(file, pos, SEEK_SET); // Move file pointer to the beginning of the record
            fwrite(&p, sizeof(p), 1, file); // Write modified record
            printf("\nRecord modified successfully.\n");
            break;
        }
        pos = ftell(file);
    }

    if (!found) {
        printf("\nRecord not found.\n");
    }
}

void Phonebook::searchRecord() {
    struct Person p;
    char name[MAX_NAME_LENGTH];
    printf("\nEnter the name of the person to search: ");
    fgets(name, MAX_NAME_LENGTH, stdin);
    name[strcspn(name, "\n")] = 0; // Remove newline character

    bool found = false;

    while (fread(&p, sizeof(p), 1, file) == 1) {
        if (strcmp(p.name, name) == 0) {
            found = true;
            printf("\nRecord found:\n");
            printf("Name: %s\nAddress: %s\nFather's Name: %s\nMother's Name: %s\nPhone No.: %s\nSex: %s\nE-mail: %s\nCitizen No.: %s\n",
                   p.name, p.address, p.father_name, p.mother_name, p.mble_no, p.sex, p.mail, p.citision_no);
            break;
        }
    }

    if (!found) {
        printf("\nRecord not found.\n");
    }
}

void Phonebook::deleteRecord() {
    struct Person p;
    char name[MAX_NAME_LENGTH];
    printf("\nEnter the name of the person to delete: ");
    fgets(name, MAX_NAME_LENGTH, stdin);
    name[strcspn(name, "\n")] = 0; // Remove newline character

    bool found = false;
    FILE *temp = fopen("temp", "wb");

    while (fread(&p, sizeof(p), 1, file) == 1) {
        if (strcmp(p.name, name) != 0) {
            fwrite(&p, sizeof(p), 1, temp);
        } else {
            found = true;
        }
    }

    fclose(file);
    fclose(temp);

    remove("project");
    rename("temp", "project");

    if (found) {
        printf("\nRecord deleted successfully.\n");
    } else {
        printf("\nRecord not found.\n");
    }

    file = fopen("project", "ab+");
}


void Phonebook::writePersonToFile(struct Person *p) {
    fwrite(p, sizeof(struct Person), 1, file);
}

void Phonebook::readPersonFromFile(struct Person *p) {
    fread(p, sizeof(struct Person), 1, file);
}

void Phonebook::freePersonMemory(struct Person *p) {
    free(p->name);
    free(p->address);
    free(p->father_name);
    free(p->mother_name);
    free(p->mble_no);
    free(p->sex);
    free(p->mail);
    free(p->citision_no);
}

char *Phonebook::getStringInput(const char *prompt) {
    char *buffer = (char *)malloc(MAX_NAME_LENGTH * sizeof(char));
    printf("%s", prompt);
    fgets(buffer, MAX_NAME_LENGTH, stdin);
    buffer[strcspn(buffer, "\n")] = 0; // remove newline character
    return buffer;
}

int main() {
    Phonebook pb("project");
    pb.addRecord();
    pb.listRecord();
    // Add other operations as needed
    return 0;
}
